# 小智ESP32设备认证系统开发计划（本地开发环境）

## 一、总体规划

### 目标
实现基于激活码的设备认证系统，使ESP32设备可通过用户输入的激活码获取WebSocket访问令牌。

### 实施策略
1. 先实现manager-api核心功能
2. 再扩展xiaozhi-server认证机制
3. 最后开发manager-web用户界面

## 二、数据模型设计

### 1. 数据库表结构设计

#### 设备表 (t_device)
- id: 主键
- mac_address: 设备MAC地址，唯一
- client_id: 设备UUID
- name: 设备名称
- type: 设备类型
- status: 设备状态（未激活/等待激活/已激活）
- user_id: 关联用户ID（外键）
- create_time: 创建时间
- update_time: 更新时间

#### 激活码表 (t_activation_code)
- id: 主键
- code: 6位数字激活码
- device_id: 关联设备ID（外键）
- status: 状态（有效/已使用/已过期）
- expire_time: 过期时间
- create_time: 创建时间

#### 访问令牌表 (t_access_token)
- id: 主键
- device_id: 关联设备ID（外键）
- token: JWT令牌
- is_revoked: 是否已撤销
- expire_time: 过期时间
- create_time: 创建时间

### 2. Redis存储设计
- "activation:code:{code}": 激活码详情（Hash结构）
- "token:active:{device_id}": 设备当前活跃令牌
- "token:revoked:{token_id}": 已撤销令牌集合（Set结构）

## 三、实施里程碑与任务

### 里程碑1：Manager API 基础设施搭建

#### 任务1.1：数据库设计与初始化
- 创建上述表结构的Liquibase变更脚本
- 实现Entity类和Repository接口
- 实现基础CRUD服务

#### 任务1.2：Redis集成
- 配置Redis连接
- 实现Redis工具类，支持Hash和Set操作
- 实现令牌和激活码缓存管理

#### 测试点：
- 数据库表创建是否成功
- Entity与数据库映射是否正确
- Redis连接和操作是否正常

### 里程碑2：设备激活码系统（Manager API）

#### 任务2.1：激活码生成与管理
- 实现激活码生成服务
- 实现激活码有效性验证
- 实现定时清理过期激活码任务

#### 任务2.2：设备注册与管理
- 实现设备注册API
- 实现设备状态管理服务
- 设备与激活码关联机制

#### 测试点：
- 激活码生成是否随机且唯一
- 激活码是否正确关联到设备
- 激活码是否按预期过期
- 设备状态转换是否正确

### 里程碑3：JWT令牌系统（Manager API）

#### 任务3.1：JWT令牌生成
- 实现JWT配置和工具类
- 设计令牌结构和声明（设备ID、权限等）
- 实现令牌生成服务

#### 任务3.2：令牌管理
- 实现令牌存储和查询服务
- 实现令牌验证和撤销功能
- 实现令牌定期清理机制

#### 测试点：
- JWT令牌格式是否符合规范
- 令牌验证是否正确工作
- 令牌撤销是否有效
- 令牌过期机制是否生效

### 里程碑4：OTA API增强（Manager API）

#### 任务4.1：OTA接口设计
- 实现/xiaozhi/ota/接口
- 根据设备状态返回不同响应
- 集成激活码和令牌生成服务

#### 任务4.2：响应格式实现
- 实现各状态下的响应构建逻辑
- 处理不同设备类型的OTA请求
- 实现错误处理和状态码映射

#### 测试点：
- OTA接口是否正确接收设备请求
- 是否根据设备状态返回正确响应
- 未激活设备是否收到激活码
- 已激活设备是否收到访问令牌

### 里程碑5：WebSocket认证扩展（Xiaozhi Server）

#### 任务5.1：认证中间件实现
- 创建FastAPI认证依赖
- 实现Bearer令牌解析和验证
- 集成与manager-api的令牌验证

#### 任务5.2：连接状态管理
- 实现设备连接状态跟踪
- 记录设备在线/离线状态
- 实现连接统计功能

#### 测试点：
- WebSocket认证是否正确验证令牌
- 无效令牌是否被正确拒绝
- 过期令牌是否触发断开连接
- 设备连接状态是否正确跟踪

### 里程碑6：服务间通信（Manager API与Xiaozhi Server）

#### 任务6.1：令牌验证API
- 在Manager API中实现令牌验证接口
- 实现令牌状态查询接口
- 配置接口安全和限流

#### 任务6.2：状态同步机制
- 实现设备状态推送机制
- 实现连接事件通知机制
- 配置跨服务通信安全

#### 测试点：
- 令牌验证API是否正确响应
- Xiaozhi Server是否能正确调用验证API
- 状态同步是否及时准确
- 通信安全措施是否有效

### 里程碑7：用户-设备关联（Manager Web与Manager API）

#### 任务7.1：设备激活API
- 实现用户输入激活码API
- 实现用户-设备关联逻辑
- 实现设备列表查询API

#### 任务7.2：用户界面集成
- 实现激活码输入界面
- 实现设备管理界面
- 实现设备状态显示组件

#### 测试点：
- 用户能否成功输入激活码
- 设备是否正确关联到用户
- 用户界面是否正确显示设备状态
- 解除关联功能是否正常工作

## 四、集成测试计划

### 测试场景1：设备初始激活流程
1. 设备发起OTA请求
2. 服务器返回激活码
3. 用户在Web界面输入激活码
4. 设备再次请求OTA并获取访问令牌
5. 设备使用令牌建立WebSocket连接

### 测试场景2：设备认证与通信
1. 设备使用令牌建立WebSocket连接
2. 测试音频传输和语音交互功能
3. 断开连接后重新连接测试
4. 模拟设备重启后的令牌持久化测试

### 测试场景3：令牌管理
1. 测试令牌过期处理
2. 测试令牌撤销（解绑设备）
3. 测试令牌刷新机制
4. 测试多设备同时连接场景

### 测试场景4：安全测试
1. 测试无效令牌的拒绝机制
2. 测试激活码暴力破解防护
3. 测试跨用户访问防护
4. 测试已撤销令牌的拒绝机制

## 五、本地开发环境配置

### 1. 环境准备
- MySQL数据库（单实例）
- Redis（单实例）
- JDK 21（Manager API）
- Python 3.9+（Xiaozhi Server）
- Node.js 18+（Manager Web）

### 2. 服务配置
- Manager API: http://localhost:8002
- Xiaozhi Server: ws://localhost:8000
- Manager Web: http://localhost:8001

### 3. 测试工具
- Postman（API测试）
- WebSocket测试客户端
- ESP32模拟器或测试固件
- Redis客户端（监控缓存状态）

## 六、监控与日志系统

### 1. 日志配置
- Manager API: 使用logback记录详细认证相关日志
- Xiaozhi Server: 配置详细的WebSocket连接和认证日志
- 日志级别: DEBUG（本地开发环境）

### 2. 监控指标
- 活跃设备数量
- 认证成功/失败率
- 平均认证耗时
- 激活码使用情况统计
- WebSocket连接状态统计
